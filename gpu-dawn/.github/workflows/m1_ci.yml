name: CI M1
on:
  workflow_run:
    workflows: ["Draft release"]
    types:
      - completed
jobs:
  aarch64-macos:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: [self-hosted, macOS, ARM64]
    defaults:
      run:
        shell: "/usr/bin/arch -arch arm64e /bin/bash --noprofile --norc -eo pipefail {0}"
    steps:
      - name: Clean repository submodules
        # See https://github.com/actions/checkout/issues/385
        run: |
          rm -rf $GITHUB_WORKSPACE && mkdir $GITHUB_WORKSPACE
      - name: Checkout
        uses: actions/checkout@v2
      - name: Setup Zig
        run: |
          zig version
      - name: Clone mach-glfw
        run: rm libs/mach-glfw && git clone https://github.com/hexops/mach-glfw libs/mach-glfw
      - name: install (debug)
        run: zig build install -Ddawn-from-source=true -Dtarget=aarch64-macos.12
        env:
          AGREE: true
      - name: upload (debug)
        run: |
          mv zig-out/lib/libdawn.a zig-out/lib/libdawn_aarch64-macos.12---12-gnu_debug.a
          gzip -9 zig-out/lib/libdawn_aarch64-macos.12---12-gnu_debug.a
          gh release upload "release-$(git rev-parse --short HEAD)" zig-out/lib/libdawn_aarch64-macos.12---12-gnu_debug.a.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: install (release-fast)
        run: zig build install -Ddawn-from-source=true -Drelease-fast=true -Dtarget=aarch64-macos.12
        env:
          AGREE: true
      - name: upload (release-fast)
        run: |
          mv zig-out/lib/libdawn.a zig-out/lib/libdawn_aarch64-macos.12---12-gnu_release-fast.a
          gzip -9 zig-out/lib/libdawn_aarch64-macos.12---12-gnu_release-fast.a
          gh release upload "release-$(git rev-parse --short HEAD)" zig-out/lib/libdawn_aarch64-macos.12---12-gnu_release-fast.a.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
